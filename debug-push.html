<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Push Notifications</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Push Notifications</h1>
        
        <div id="status"></div>
        
        <div>
            <button onclick="checkSettings()">1. Check Chrome Settings</button>
            <button onclick="testDirectNotification()">2. Test Direct Notification</button>
            <button onclick="checkServiceWorker()">3. Check Service Worker</button>
            <button onclick="testPushEvent()">4. Simulate Push Event</button>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        function log(msg) {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${time}] ${msg}<br>`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(msg);
        }

        function showStatus(msg, type) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.textContent = msg;
        }

        async function checkSettings() {
            log('=== Checking Chrome Notification Settings ===');
            
            // Check permission
            if ('Notification' in window) {
                const perm = Notification.permission;
                log(`Notification permission: ${perm}`);
                
                if (perm === 'granted') {
                    log('‚úÖ Permission is granted');
                } else if (perm === 'denied') {
                    log('‚ùå Permission is DENIED');
                    log('Go to: chrome://settings/content/notifications');
                    log('Find localhost and make sure it\'s allowed');
                } else {
                    log('‚ö†Ô∏è Permission not requested yet');
                }
            } else {
                log('‚ùå Notifications not supported');
            }
            
            // Check service worker
            if ('serviceWorker' in navigator) {
                log('‚úÖ Service workers supported');
                try {
                    const reg = await navigator.serviceWorker.getRegistration();
                    if (reg) {
                        log(`‚úÖ Service worker registered: ${reg.scope}`);
                        log(`   Active: ${reg.active ? 'Yes' : 'No'}`);
                        log(`   Installing: ${reg.installing ? 'Yes' : 'No'}`);
                        log(`   Waiting: ${reg.waiting ? 'Yes' : 'No'}`);
                    } else {
                        log('‚ùå No service worker registered');
                    }
                } catch (e) {
                    log(`‚ùå Error checking service worker: ${e.message}`);
                }
            } else {
                log('‚ùå Service workers not supported');
            }
            
            // Check push manager
            if ('PushManager' in window) {
                log('‚úÖ Push Manager supported');
                try {
                    const reg = await navigator.serviceWorker.ready;
                    const sub = await reg.pushManager.getSubscription();
                    if (sub) {
                        log(`‚úÖ Push subscription exists`);
                        log(`   Endpoint: ${sub.endpoint.substring(0, 50)}...`);
                    } else {
                        log('‚ùå No push subscription');
                    }
                } catch (e) {
                    log(`‚ùå Error checking subscription: ${e.message}`);
                }
            } else {
                log('‚ùå Push Manager not supported');
            }
        }

        async function testDirectNotification() {
            log('=== Testing Direct Notification ===');
            
            if (Notification.permission !== 'granted') {
                log('‚ùå Permission not granted');
                showStatus('‚ùå Permission not granted', 'error');
                return;
            }
            
            try {
                const notif = new Notification('Test Direct Notification', {
                    body: 'If you see this, notifications work!',
                    icon: '/app-icon.jpg',
                    badge: '/app-icon.jpg',
                    tag: 'test-direct'
                });
                
                log('‚úÖ Direct notification created');
                showStatus('‚úÖ Direct notification sent - check if it appears!', 'success');
                
                notif.onclick = () => {
                    log('Notification clicked');
                };
                
                setTimeout(() => {
                    notif.close();
                }, 5000);
            } catch (e) {
                log(`‚ùå Error: ${e.message}`);
                showStatus(`‚ùå Error: ${e.message}`, 'error');
            }
        }

        async function checkServiceWorker() {
            log('=== Checking Service Worker Status ===');
            
            try {
                const reg = await navigator.serviceWorker.getRegistration();
                if (!reg) {
                    log('‚ùå No service worker registered');
                    return;
                }
                
                log(`Service Worker Scope: ${reg.scope}`);
                log(`Active: ${reg.active ? 'Yes' : 'No'}`);
                
                if (reg.active) {
                    log('‚úÖ Service worker is active');
                    log('Sending message to service worker...');
                    
                    // Create a message channel for response
                    const channel = new MessageChannel();
                    
                    channel.port1.onmessage = (event) => {
                        log(`‚úÖ Service worker responded: ${JSON.stringify(event.data)}`);
                    };
                    
                    reg.active.postMessage({
                        type: 'TEST',
                        message: 'Hello from debug page'
                    }, [channel.port2]);
                    
                    log('Message sent - waiting for response...');
                    
                    // Also check service worker console directly
                    log('üí° Open service worker console: F12 ‚Üí Application ‚Üí Service Workers ‚Üí Click "inspect"');
                } else {
                    log('‚ö†Ô∏è Service worker not active yet');
                }
                
                // Check for push event listener
                log('Checking if service worker has push listener...');
                log('üí° To verify push events, send a notification and check service worker console');
                log('üí° Service worker should log: "Push notification received" when notification arrives');
                
            } catch (e) {
                log(`‚ùå Error: ${e.message}`);
            }
        }

        async function testPushEvent() {
            log('=== Testing Push Event Reception ===');
            
            try {
                const reg = await navigator.serviceWorker.ready;
                const sub = await reg.pushManager.getSubscription();
                
                if (!sub) {
                    log('‚ùå No subscription found');
                    return;
                }
                
                log('Subscription found');
                log('Sending test notification via service worker...');
                
                // Send notification through service worker
                await reg.showNotification('Test Push Notification', {
                    body: 'This tests if service worker can show notifications',
                    icon: '/app-icon.jpg',
                    badge: '/app-icon.jpg',
                    tag: 'test-push',
                    requireInteraction: false
                });
                
                log('‚úÖ Notification sent via service worker');
                showStatus('‚úÖ Test notification sent - check if it appears!', 'success');
                
            } catch (e) {
                log(`‚ùå Error: ${e.message}`);
                showStatus(`‚ùå Error: ${e.message}`, 'error');
            }
        }

        // Listen for service worker messages
        navigator.serviceWorker.addEventListener('message', (event) => {
            log(`Message from service worker: ${JSON.stringify(event.data)}`);
        });

        log('Debug page ready');
        log('Click buttons above to check different aspects');
    </script>
</body>
</html>

